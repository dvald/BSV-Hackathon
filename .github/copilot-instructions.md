# Project Analysis and Development Guide

This document provides a comprehensive overview of the repository's structure, conventions, and established patterns. It is intended to be used as a primary guide and context prompt for any developer or AI assistant working on this project.

---

## 1. General Development Instructions

These are high-level rules that must be followed across the project to maintain consistency and quality. More specific rules for each section are detailed below.

- **Code Cleanliness:** Do not include icons, emojis, or emoticons in code comments, test descriptions, commit messages, or log messages.
- **Centralized Logging (Backend):** Do not use `console.log` for logging in the backend. All server-side logs must be routed through the centralized `Monitor` class found at `web-application/backend/src/monitor.ts`. Use the Monitor exclusively for server-side logs.
- **API Documentation for Code Generation:**
  - **Generator Script:** The entire API client layer—including TypeScript definitions and calling functions—is generated by the `web-application/backend/scripts/gen-api-bindings.js` script. **Do not modify generated files manually.** The script works by parsing JSDoc comments in the backend controller files.
  - **Required Action:** To add or modify an API endpoint, you must document it with a specific JSDoc format above the controller function in its corresponding file within `web-application/backend/src/controllers/api/`.
  - **How to add/modify an endpoint:**
    1. Add `@typedef` blocks for request/response/error models.
    2. Add an endpoint JSDoc block (summary + `Binding:` + `@route` + `@group` + `@param` + `@returns` + `@security`).
    3. Run the generator script: `npm run update-api-bindings` (which executes `scripts/gen-api-bindings.js`).
  - **Structure of Comments:**
    1.  **Model Definitions (`@typedef`):** First, define any request, response, or error models in separate JSDoc blocks using `@typedef`. Each property is defined with `@property {{type}} {name}.required - {description}`.
    2.  **Endpoint Definition:** After the models, use a final JSDoc block to define the endpoint. This includes a summary, a custom `Binding:` tag (which sets the generated function's name), and JSDoc tags like `@route`, `@group`, `@param`, `@returns`, and `@security`.
  - **Reusing Types:** Before defining a new `@typedef`, always check if a suitable model already exists in other controller files to avoid duplication.
  - **Example of the Correct JSDoc Format:**
    ```javascript
    /**
     * @typedef UsernameChangeRequest
     * @property {string} username.required - New username
     * @property {string} password.required - Account password
     * @property {string} tfa_token - Two factor authentication code (required if 2FA enabled)
     */

    /**
     * @typedef UsernameChangeBadRequest
     * @property {string} code.required - Error code:
     * - WRONG_PASSWORD
     * - USERNAME_INVALID
     * - USERNAME_IN_USE
     * - INVALID_TFA_CODE
     */

    /**
     * Changes username
     * Binding: ChangeUsername
     * @route POST /account/username
     * @group account
     * @param {UsernameChangeRequest.model} request.body - Request body
     * @returns {UsernameChangeBadRequest.model} 400 - Bad request
     * @returns {void} 200 - Success
     * @security AuthToken
     */
    ```
- **Centralized Error Handling (Backend):** Use the utility functions `sendError` and `sendSuccess` from `web-application/backend/src/utils/http-utils.ts` to format all API responses. This ensures error payloads and success responses are consistent across the application.
- **Follow Naming Conventions:** Adhere strictly to the naming conventions for files, classes, functions, and variables as outlined in the "Code Conventions" section.

---

## 2. Tech Stack

- **Frontend (`web-application/frontend`):**
  - **Framework:** Vue.js 3 (using `vue` package).
  - **Language:** TypeScript.
  - **Router:** Vue Router (using `vue-router` package).
  - **State Management/Logic:** Vue 3 Composition API patterns. No global state library like Vuex/Pinia is used. State logic is managed in `src/control/` files like `auth.ts`.
  - **Internationalization (i18n):** `vue-i18n` package.
  - **Build Tool:** Vite (configured in `vite.config.js`).
  - **Styling:** Plain CSS with CSS Variables for theming. Global styles are in `web-application/frontend/src/style/`, with key files like `main.css`, `theme.css`, and `variables.css`.

- **Backend (`web-application/backend`):**
  - **Framework:** Express.js (using `express` package).
  - **Language:** TypeScript.
  - **ORM / Database:** The project uses `tsbean-orm`, a multi-database ORM. It supports MongoDB, MySQL, and PostgreSQL via its drivers (`tsbean-driver-mongo`, `tsbean-driver-mysql`, `tsbean-driver-postgres`). The active database is determined by environment configuration.
  - **Cache/Messaging:** Redis (using `redis` package).
  - **Blockchain Interaction:** Ethers.js and `@asanrom/smart-contract-wrapper`. The latter is used to interact with generated TypeScript contract wrappers located in `web-application/backend/src/contracts/`.
  - **Authentication:** Database-backed session tokens. A session document (defined in `src/models/users/session.ts`) with a unique token is stored in the database for each user login.
  - **Emailing:** Nodemailer (using `nodemailer` package), with email templates in `src/emails/`.

- **Smart Contracts (`smart-contracts`):**
  - **Language:** Solidity.
  - **Development Framework:** Hardhat.
  - **Libraries & Tooling:** Ethers.js, TypeChain, and `@asanrom/smart-contract-wrapper`. A custom script (`src/generate-contract-wrappers.ts`) uses this library to generate strongly-typed TypeScript classes from the contract ABIs, which are then used by the backend.

- **Mobile Application (`mobile-application`):**
  - **Framework:** React Native (using `react` and `react-native` packages).
  - **Toolkit:** Expo (using the `expo` package).
  - **Language:** TypeScript / TSX.
  - **Navigation:** React Navigation (using `@react-navigation/native`).

- **Infrastructure & Deployment:**
  - **Containerization:** Docker, Docker Compose.
  - **CI/CD:** GitHub Actions (see `deployment-scripts/GITHUB_ACTIONS_CI.md`) and Jenkins (see `Jenkinsfile`).
  - **Orchestration/Automation:** Ansible (see `deployment-scripts/auto-deploy.yml`).

## 3. Repository Structure
 
Below is a simplified directory tree of the project.
```plaintext
├── README.md
├── besu-test-node
│   ├── README.md
│   ├── docker-compose.yml
│   └── networkFiles
│       └── config
│           └── genesis.json
├── deployment-scripts
│   ├── DEPLOYMENT_GUIDE.md
│   ├── GITHUB_ACTIONS_CI.md
│   ├── README.md
│   ├── auto-deploy.yml
│   └── monitoring-tools
│       ├── README.md
│       ├── development
│       │   ├── README.md
│       │   └── docker-compose.yml
│       └── production
│           ├── README.md
│           └── docker-compose.yml
├── jenkins-utils
│   ├── mongodb
│   │   └── docker-compose.yml
│   └── redis
│       └── docker-compose.yml
├── mobile-application
│   ├── App.tsx
│   ├── app.config.js
│   ├── package.json
│   └── src
│       ├── api
│       ├── components
│       ├── control
│       ├── hooks
│       ├── locales
│       ├── style
│       └── utils
├── smart-contracts
│   ├── README.md
│   ├── package.json
│   ├── src
│   │   ├── config
│   │   ├── contract-wrappers
│   │   ├── tests
│   │   └── utils
│   └── tsconfig.json
└── web-application
├── README.md
├── backend
│   ├── package.json
│   ├── src
│   │   ├── config
│   │   ├── controllers
│   │   ├── contracts
│   │   ├── database
│   │   ├── emails
│   │   ├── locales
│   │   ├── models
│   │   ├── services
│   │   └── utils
│   └── test
│       └── mocha
│           ├── api-tests
│           ├── function-tests
│           └── test-tools
└── frontend
├── index.html
├── package.json
├── src
│   ├── api
│   ├── assets
│   ├── components
│   ├── control
│   ├── locales
│   ├── style
│   └── utils
└── vite.config.js
```
- **`besu-test-node/`**: Configuration for a Hyperledger Besu test node.
  - **Extensions:** `.yml`, `.json`
  - **Example:** `docker-compose.yml` to run the node.
- **`deployment-scripts/`**: Scripts and guides for deployment and monitoring.
  - **Extensions:** `.yml`, `.md`
  - **Example:** `auto-deploy.yml` (Ansible playbook).
- **`mobile-application/`**: Source code for the React Native mobile app.
  - **Extensions:** `.tsx`, `.ts`, `.json`
  - **Example:** `src/components/screens/HomeScreen.tsx`.
- **`smart-contracts/`**: Smart contracts and their deployment/testing scripts.
  - **Extensions:** `.sol`, `.ts`
  - **Example:** `src/tests/test-example-contract.ts`.
- **`web-application/`**: The main web application.
  - **`backend/`**: REST API, business logic, and database connection.
    - **Extensions:** `.ts`, `.json`
    - **Example:** `src/controllers/api/api-auth.ts`.
  - **`frontend/`**: User interface built with Vue.js.
    - **Extensions:** `.vue`, `.ts`, `.css`
    - **Example:** `src/components/routes/HomePage.vue`.

## 4. Code Conventions

- **File Naming:**
  - `kebab-case` is used for most files.
  - **Examples:** `api-group-account.ts`, `main-layout.css`, `users-service.ts`.
  - Vue components use `PascalCase`.
  - **Example:** `HomePage.vue`, `ModalDialogContainer.vue`.

- **Class, Function, and Variable Naming:**
  - **Classes:** `PascalCase`. Example: `class UsersService`, `class Monitor`.
  - **Functions & Methods:** `camelCase`. Example: `async function getUserProfile()`, `sendError()`.
  - **Constants:** `UPPER_SNAKE_CASE`. Example: `const MONGO_DB_URL`.
  - **Interfaces (TypeScript):** `PascalCase` without prefixes like `I`. Example: `interface UserProfile`.

- **Code Formatting:**
  - **Imports:** Grouped by origin (external libraries, project aliases).
  - **Spacing:** Consistent spacing is used (4 spaces for indentation in the backend, 2 spaces in the frontend, as enforced by the respective Prettier/ESLint configurations).
  - **Line Length:** Generally kept under 120 characters.
  - **Trailing Commas:** Used at the end of multiline object property lists and arrays.
  - **Semicolons:** Semicolons are used at the end of each statement in TypeScript.

## 5. Logging

- **Centralization:** All **backend** logging logic must go through the `Monitor` class, located at `web-application/backend/src/monitor.ts`. This class centralizes writing logs to the console and, optionally, to files. It is typically accessed via `req.monitor` in controllers.
- **Log Levels:**
  - `debug`: For detailed information useful during development.
  - `info`: For important application flow events (e.g., "Server started").
  - `warn`: For unexpected but non-critical situations.
  - `error`: For captured errors that prevent an operation from completing.
- **Standard Format:** `[YYYY-MM-DD HH:mm:ss.SSS] [LEVEL] [TAG] Message`
  - **Example:** `[2023-10-27 10:30:00.123] [ERROR] [API-AUTH] Login failed for user test@example.com`

## 6. Error Handling

- **Error Capturing (Backend):**
  - **Controllers:** `try/catch` blocks are used within controller functions to catch synchronous and asynchronous errors.
  - **Global Middleware:** In `web-application/backend/src/app.ts`, a global error-handling middleware is configured as the last `app.use()` to catch any unhandled errors from the controllers.
  - **Request Errors:** Validators are used to check the `body`, `query`, and `params` of requests before processing them.

- **Canonical Error Responses:**
  - Error responses must follow a consistent format, managed by the `sendError` and `sendErrorMessage` functions from `web-application/backend/src/utils/http-utils.ts`.
  - **HTTP Code:** The semantically correct HTTP status code is used (e.g., `400` for Bad Request, `401` for Unauthorized, `404` for Not Found, `500` for Internal Server Error).
  - **Error Payload:** The response body is a JSON object with an `error` key.
    - **Example:** `sendError(res, 'USERNAME_IN_USE', 400)` which results in `res.status(400).json({ error: 'USERNAME_IN_USE' })`

## 7. API & Models

- **API (Backend):**
  - **Routes:** Routes are defined in the controllers and follow the pattern `/api/v1/{group}/{action}`.
    - **Example:** `POST /api/v1/auth/login`
  - **Controllers:** Located in `web-application/backend/src/controllers/api/`. Each file groups related functionalities (e.g., `api-auth.ts`, `api-account.ts`).
  - **DTOs (Data Transfer Objects):** The interfaces defining the shape of request and response data are defined via JSDoc comments in the controller files. These comments are the single source of truth and are used by the `gen-api-bindings.js` script to generate the `definitions.ts` files for the frontend and backend tests.

- **Models (Backend):**
  - **Declaration:** Models are defined using a two-class pattern from the `tsbean-orm` library.
    1.  A plain data class that extends `DataModel` to define the shape of the data (e.g., `class User extends DataModel`).
    2.  A manager class that extends `Model<T>` (e.g., `class UserModel extends Model<User>`).
  - **Configuration:** All database mapping, including the collection/table name, fields, types, validation rules, and indexes, is configured programmatically within the constructor of the manager class, not through decorators.
  - **Location:** Models are located in `web-application/backend/src/models/`. They are organized into subfolders if necessary (e.g., `models/users/`).
  - **Example:** `web-application/backend/src/models/users/user.ts` defines the `User` data class and the `UserModel` manager class. The `UserModel` constructor configures the 'users' collection and its fields using methods like `this.addField()` and `this.addIndex()`.


## 8. Frontend

- **Folder Structure (`web-application/frontend/src/`):**
  - **`components/`**: Contains all `.vue` components.
    - **`routes/`**: Components that represent full pages, linked to a route.
    - **`modals/`**: Modal dialog components.
    - **`layout/`**: Structural components like `TopBar.vue`, `MenuSideBar.vue`.
    - **`utils/`**: Generic and reusable components (e.g., `PasswordInput.vue`).
  - **`style/`**: Global and thematic CSS stylesheets.
  - **`api/`**: Logic for making calls to the backend API (mostly auto-generated).
  - **`control/`**: Business logic and local application state (e.g., `auth.ts`, `wallets.ts`).
  - **`locales/`**: JSON translation files for i18n.
  - **`composables/`**: Reusable composition functions (e.g., `useTheme.ts`).

- **Naming Conventions:**
  - **Components:** `PascalCase.vue` (e.g., `UserProfilePage.vue`).
  - **Stylesheets:** `kebab-case.css` (e.g., `main-layout.css`).

## 9. Testing

- **Testing Framework (Backend):** **Mocha** is used as the execution framework, and **Chai** is used for assertions.
- **Folder Structure:**
  - `web-application/backend/test/mocha/`
    - **`api-tests/`**: Integration tests that make HTTP calls to the API.
    - **`function-tests/`**: Unit tests for specific functions and utilities.
    - **`test-tools/`**: Utilities to help with writing tests (e.g., `api-tester.ts`).
- **File Naming Pattern:**
  - `tests-api-{feature}.ts` for API tests. (e.g., `tests-api-auth.ts`)
  - `test-{utility}.ts` for unit tests. (e.g., `test-aes.ts`)

---

## 10. Modular Architecture & API Integration

- **Boundaries:**
  - Frontend/Mobile ↔ Backend via REST only. No direct DB access from clients.

- **Bindings:**
  - After changing backend endpoints/JSDoc, regenerate bindings using `npm run update-api-bindings`.
  - Clients must use generated request functions (do not hand-write fetch calls to our API).

- **Shared Utilities:**
  - Prefer existing helpers in each module's `utils/` rather than reinventing functionality.

---

## 11. Git Workflow & Commit Policy

- **Commit Messages (Conventional Commits, English):**
  - **Format:** `<type>(<scope>): <description>`
  - **Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`, etc.
  - **Examples:**
    - `feat(auth): add username change endpoint`
    - `fix(api): return USERNAME_IN_USE error code`

- **Branching:**
  - `main`: production-ready at all times.
  - `develop`: integration branch for next release (auto-deployed to dev/test).
  - `feature/<name>` and `fix/<name>` from `develop`.
  - `hotfix/<name>` from `main` (merge back to both `main` and `develop`).

- **Pull Requests:**
  - Open PRs into `develop` (or `main` for hotfix).
  - At least one reviewer required.
  - CI (build, lint, tests) must pass.
  - Address review comments; keep PRs small and focused.
  - Squash or merge per repo policy; ensure clean history.

---

## 12. CI/CD, Tooling & Scripts

- **CI:**
  - GitHub Actions runs on PRs and on pushes to `develop`/`main`.
  - Pipelines build all modules and run tests/linting. Do not bypass checks.

- **Common Tasks:**
  - **Install:** `npm ci` (per module)
  - **Lint:** `npm run lint`
  - **Test:** `npm test`
  - **Generate API bindings (backend → clients):** `npm run update-api-bindings` (script executes `scripts/gen-api-bindings.js` and updates `web-application/frontend/src/api/` and test definitions as configured)
  - **Generate contract wrappers (in smart-contracts):** run `generate-contract-wrappers.ts` (see package scripts)

---

## 13. Configuration & Secrets

- Use environment variables and checked-in `.env.example` files.
- Never commit secrets/keys/passwords.
- If a secret is required, fetch from env or secret manager. Reject any suggestion to hard-code credentials.

---

## 14. Besu Test Node

- `besu-test-node/` provides a local Hyperledger Besu network configuration.
- Start with `docker-compose.yml`; customize `networkFiles/config/genesis.json` as needed for development.

---

## 15. Quality Checklist (pre-PR)

- Lint passes locally.
- Unit/integration tests added/updated and passing.
- API JSDoc updated for any endpoint changes; bindings regenerated.
- No `console.log` in backend; logging via Monitor.
- Errors returned with proper codes and standardized payloads.
- Commit messages follow Conventional Commits.
- Documentation/comments updated where necessary.

